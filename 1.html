<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß© –ü–æ—Å—Ç–µ—Ä-–ú–æ–∑–∞–∏–∫–∞ ‚Äî –†–∞–∑–±–∏–≤–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –Ω–∞ –ª–∏—Å—Ç—ã</title>
    
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #4A90D9;
            --primary-hover: #357ABD;
            --success: #27AE60;
            --warning: #F39C12;
            --danger: #E74C3C;
            --bg: #F5F7FA;
            --card: #FFFFFF;
            --text: #2C3E50;
            --text-light: #7F8C8D;
            --border: #E1E8ED;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --radius: 16px;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            font-size: 18px;
            line-height: 1.5;
        }
        
        /* –®–∞–ø–∫–∞ */
        .header {
            background: linear-gradient(135deg, var(--primary), #6C5CE7);
            color: white;
            padding: 24px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* –®–∞–≥–∏ */
        .steps {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            background: var(--card);
            border-radius: 50px;
            box-shadow: var(--shadow);
            opacity: 0.5;
            transition: all 0.3s;
        }
        
        .step.active {
            opacity: 1;
            background: var(--primary);
            color: white;
        }
        
        .step.completed {
            opacity: 1;
            background: var(--success);
            color: white;
        }
        
        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .step.active .step-number,
        .step.completed .step-number {
            background: rgba(255,255,255,0.3);
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 32px;
            margin-bottom: 24px;
        }
        
        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .card-title .icon {
            font-size: 1.6rem;
        }
        
        /* –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .upload-zone {
            border: 3px dashed var(--border);
            border-radius: var(--radius);
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #f8f9fa, #fff);
        }
        
        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #e8f4fd, #fff);
            transform: scale(1.01);
        }
        
        .upload-zone .icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .upload-zone h3 {
            font-size: 1.5rem;
            margin-bottom: 12px;
        }
        
        .upload-zone p {
            color: var(--text-light);
            font-size: 1.1rem;
        }
        
        .upload-zone input {
            display: none;
        }
        
        /* –î–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π –º–∞–∫–µ—Ç */
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
            align-items: start;
        }
        
        @media (max-width: 1000px) {
            .two-columns {
                grid-template-columns: 1fr;
            }
        }
        
        /* –ü—Ä–µ–≤—å—é */
        .preview-container {
            position: relative;
            background: #1a1a2e;
            border-radius: var(--radius);
            overflow: hidden;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-wrapper {
            position: relative;
            max-width: 100%;
            max-height: 600px;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 600px;
            display: block;
        }
        
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .grid-cell {
            position: absolute;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(74, 144, 217, 0.1);
        }
        
        .grid-cell-label {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–º–µ—Ä–µ */
        .size-info {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 16px;
            border-radius: 12px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .size-info-item {
            text-align: center;
        }
        
        .size-info-label {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .size-info-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .quality-good { color: #27AE60; }
        .quality-medium { color: #F39C12; }
        .quality-bad { color: #E74C3C; }
        
        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-group {
            margin-bottom: 24px;
        }
        
        .settings-group:last-child {
            margin-bottom: 0;
        }
        
        .settings-label {
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        
        /* –°–µ–ª–µ–∫—Ç–æ—Ä—ã —Ñ–æ—Ä–º–∞—Ç–∞ */
        .format-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .format-btn {
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 1rem;
        }
        
        .format-btn:hover {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        
        .format-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        /* –°–µ—Ç–∫–∞ */
        .grid-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .grid-input {
            width: 70px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1.2rem;
            text-align: center;
            font-weight: 600;
        }
        
        .grid-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .grid-x {
            font-size: 1.5rem;
            font-weight: 300;
            color: var(--text-light);
        }
        
        .auto-btn {
            padding: 12px 20px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .auto-btn:hover {
            background: #219a52;
            transform: translateY(-2px);
        }
        
        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ */
        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .toggle-label {
            font-size: 1rem;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 32px;
            cursor: pointer;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            border-radius: 32px;
            transition: 0.3s;
        }
        
        .toggle-slider:before {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background: var(--primary);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(28px);
        }
        
        /* –°–ª–∞–π–¥–µ—Ä –Ω–∞—Ö–ª—ë—Å—Ç–∞ */
        .overlap-slider {
            margin-top: 12px;
            padding: 16px;
            background: #e8f4fd;
            border-radius: 12px;
            display: none;
        }
        
        .overlap-slider.visible {
            display: block;
        }
        
        .overlap-slider input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .overlap-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }
        
        .overlap-value {
            text-align: center;
            margin-top: 8px;
            font-weight: 600;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn {
            flex: 1;
            padding: 18px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #6C5CE7);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(74, 144, 217, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: var(--text);
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ */
        .export-format {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫—Ä–æ–ø–ø–µ—Ä–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: white;
            border-radius: 16px 16px 0 0;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            flex: 1;
            background: #1a1a2e;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .modal-body img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            padding: 16px 24px;
            background: white;
            border-radius: 0 0 16px 16px;
        }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å */
        .progress-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .progress-overlay.active {
            display: flex;
        }
        
        .progress-card {
            background: white;
            padding: 48px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
        }
        
        .progress-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid #f0f0f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-text {
            font-size: 1.2rem;
            color: var(--text);
        }
        
        /* –°–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ */
        .hidden {
            display: none !important;
        }
        
        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–µ–π–¥–∂–∏ */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .badge-info {
            background: #e8f4fd;
            color: var(--primary);
        }
        
        /* –ü–æ–¥—Å–∫–∞–∑–∫–∏ */
        .hint {
            background: #fffbea;
            border-left: 4px solid var(--warning);
            padding: 16px;
            border-radius: 0 12px 12px 0;
            margin-top: 16px;
            font-size: 0.95rem;
        }
        
        .hint-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        /* –§—É—Ç–µ—Ä */
        .footer {
            text-align: center;
            padding: 24px;
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .steps {
                flex-direction: column;
                align-items: center;
            }
            
            .card {
                padding: 20px;
            }
            
            .upload-zone {
                padding: 40px 20px;
            }
            
            .format-selector {
                grid-template-columns: 1fr;
            }
            
            .export-format {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <header class="header">
        <h1>üß© –ü–æ—Å—Ç–µ—Ä-–ú–æ–∑–∞–∏–∫–∞</h1>
        <p>–†–∞–∑–±–µ–π—Ç–µ –ª—é–±—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –ª–∏—Å—Ç—ã A4 –∏ –Ω–∞–ø–µ—á–∞—Ç–∞–π—Ç–µ –æ–≥—Ä–æ–º–Ω—ã–π –ø–æ—Å—Ç–µ—Ä!</p>
    </header>
    
    <main class="container">
        <!-- –®–∞–≥–∏ -->
        <div class="steps">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <span>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É</span>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <span>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</span>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <span>–°–∫–∞—á–∞–π—Ç–µ –∏ –ø–µ—á–∞—Ç–∞–π—Ç–µ</span>
            </div>
        </div>
        
        <!-- –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–®–∞–≥ 1) -->
        <div class="card" id="uploadCard">
            <div class="upload-zone" id="uploadZone">
                <div class="icon">üìÅ</div>
                <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É —Å—é–¥–∞</h3>
                <p>–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</p>
                <p style="margin-top: 12px;"><span class="badge badge-info">JPG, PNG, WebP –¥–æ 50 –ú–ë</span></p>
                <input type="file" id="fileInput" accept="image/*">
            </div>
        </div>
        
        <!-- –†–µ–¥–∞–∫—Ç–æ—Ä (–®–∞–≥ 2) -->
        <div class="hidden" id="editorSection">
            <div class="two-columns">
                <!-- –ü—Ä–µ–≤—å—é -->
                <div class="card">
                    <div class="card-title">
                        <span class="icon">üñºÔ∏è</span>
                        –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å—Ç–µ—Ä–∞
                    </div>
                    <div class="preview-container" id="previewContainer">
                        <div class="preview-wrapper" id="previewWrapper">
                            <img id="previewImage" class="preview-image" src="" alt="Preview">
                            <div class="grid-overlay" id="gridOverlay"></div>
                        </div>
                        <div class="size-info" id="sizeInfo">
                            <div class="size-info-item">
                                <div class="size-info-label">–†–∞–∑–º–µ—Ä –ø–æ—Å—Ç–µ—Ä–∞</div>
                                <div class="size-info-value" id="posterSize">‚Äî</div>
                            </div>
                            <div class="size-info-item">
                                <div class="size-info-label">–õ–∏—Å—Ç–æ–≤</div>
                                <div class="size-info-value" id="sheetsCount">‚Äî</div>
                            </div>
                            <div class="size-info-item">
                                <div class="size-info-label">–ö–∞—á–µ—Å—Ç–≤–æ –ø–µ—á–∞—Ç–∏</div>
                                <div class="size-info-value" id="printQuality">‚Äî</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="openCropper()" style="flex: 1;">
                            ‚úÇÔ∏è –û–±—Ä–µ–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É
                        </button>
                        <button class="btn btn-secondary" onclick="resetImage()" style="flex: 1;">
                            üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥—É—é
                        </button>
                    </div>
                </div>
                
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="card">
                    <div class="card-title">
                        <span class="icon">‚öôÔ∏è</span>
                        –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞—Ç –±—É–º–∞–≥–∏ -->
                    <div class="settings-group">
                        <div class="settings-label">üìÑ –§–æ—Ä–º–∞—Ç –±—É–º–∞–≥–∏</div>
                        <div class="format-selector" id="paperFormat">
                            <button class="format-btn active" data-format="A4">A4</button>
                            <button class="format-btn" data-format="A3">A3</button>
                            <button class="format-btn" data-format="A5">A5</button>
                            <button class="format-btn" data-format="Letter">Letter</button>
                        </div>
                    </div>
                    
                    <!-- –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è -->
                    <div class="settings-group">
                        <div class="settings-label">üìê –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –ª–∏—Å—Ç–∞</div>
                        <div class="format-selector" id="orientation">
                            <button class="format-btn active" data-orientation="portrait">üìÉ –ü–æ—Ä—Ç—Ä–µ—Ç</button>
                            <button class="format-btn" data-orientation="landscape">üìÉ –ê–ª—å–±–æ–º</button>
                        </div>
                    </div>
                    
                    <!-- –°–µ—Ç–∫–∞ -->
                    <div class="settings-group">
                        <div class="settings-label">üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Å—Ç–æ–≤</div>
                        <div class="grid-selector">
                            <input type="number" class="grid-input" id="gridCols" value="2" min="1" max="20">
                            <span class="grid-x">√ó</span>
                            <input type="number" class="grid-input" id="gridRows" value="2" min="1" max="20">
                            <button class="auto-btn" onclick="autoGrid()">‚ú® –ê–≤—Ç–æ</button>
                        </div>
                    </div>
                    
                    <!-- –û–ø—Ü–∏–∏ -->
                    <div class="settings-group">
                        <div class="settings-label">üéõÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</div>
                        <div class="toggle-group">
                            <div class="toggle-item">
                                <span class="toggle-label">–ù—É–º–µ—Ä–∞—Ü–∏—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="showNumbers">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-item">
                                <span class="toggle-label">–ù–∞—Ö–ª—ë—Å—Ç –¥–ª—è —Å–∫–ª–µ–π–∫–∏</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableOverlap">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="overlap-slider" id="overlapSlider">
                                <input type="range" id="overlapAmount" min="5" max="30" value="15">
                                <div class="overlap-value"><span id="overlapValue">15</span> –º–º</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
                    <div class="settings-group">
                        <div class="settings-label">üíæ –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞</div>
                        <div class="export-format" id="exportFormat">
                            <button class="format-btn active" data-export="docx">üìÑ DOCX</button>
                            <button class="format-btn" data-export="pdf">üìï PDF</button>
                            <button class="format-btn" data-export="zip">üì¶ ZIP</button>
                        </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
                    <div class="actions">
                        <button class="btn btn-primary" id="generateBtn" onclick="generateOutput()">
                            üöÄ –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–µ—Ä
                        </button>
                    </div>
                    
                    <div class="hint">
                        <div class="hint-title">üí° –°–æ–≤–µ—Ç</div>
                        –î–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å –≤—ã—Å–æ–∫–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º. 
                        –ö–∞—á–µ—Å—Ç–≤–æ "–û—Ç–ª–∏—á–Ω–æ" –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–∑–º—ã—Ç–æ–π –ø—Ä–∏ –ø–µ—á–∞—Ç–∏.
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫—Ä–æ–ø–ø–µ—Ä–∞ -->
    <div class="modal" id="cropperModal">
        <div class="modal-header">
            <div class="modal-title">‚úÇÔ∏è –û–±—Ä–µ–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            <button class="modal-close" onclick="closeCropper()">√ó</button>
        </div>
        <div class="modal-body">
            <img id="cropperImage" src="">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" style="flex:1" onclick="closeCropper()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" style="flex:1" onclick="applyCrop()">‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
    <div class="progress-overlay" id="progressOverlay">
        <div class="progress-card">
            <div class="progress-spinner"></div>
            <div class="progress-text" id="progressText">–°–æ–∑–¥–∞—ë–º –≤–∞—à –ø–æ—Å—Ç–µ—Ä...</div>
        </div>
    </div>
    
    <footer class="footer">
        –°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è –ª—é–±–∏—Ç–µ–ª–µ–π –±–æ–ª—å—à–∏—Ö –ø–æ—Å—Ç–µ—Ä–æ–≤
    </footer>

    <script>
        // ============================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        // ============================================
        const CONFIG = {
            paperSizes: {
                'A4': { width: 210, height: 297 },
                'A3': { width: 297, height: 420 },
                'A5': { width: 148, height: 210 },
                'Letter': { width: 215.9, height: 279.4 }
            },
            defaultDPI: 150,
            maxDPI: 300,
            mmToInch: 25.4,
            mmToPoint: 2.83465 // –¥–ª—è PDF
        };
        
        // ============================================
        // –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ============================================
        let state = {
            originalImage: null,
            croppedImage: null,
            imageWidth: 0,
            imageHeight: 0,
            paperFormat: 'A4',
            orientation: 'portrait',
            gridCols: 2,
            gridRows: 2,
            showNumbers: false,
            enableOverlap: false,
            overlapAmount: 15,
            exportFormat: 'docx',
            cropper: null
        };
        
        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initUpload();
            initSettings();
        });
        
        function initUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            
            // –ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ
            uploadZone.addEventListener('click', () => fileInput.click());
            
            // –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞
            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    loadImage(e.target.files[0]);
                }
            });
            
            // Drag & Drop
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    loadImage(file);
                }
            });
        }
        
        function initSettings() {
            // –§–æ—Ä–º–∞—Ç –±—É–º–∞–≥–∏
            document.querySelectorAll('#paperFormat .format-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#paperFormat .format-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.paperFormat = btn.dataset.format;
                    updatePreview();
                });
            });
            
            // –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è
            document.querySelectorAll('#orientation .format-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#orientation .format-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.orientation = btn.dataset.orientation;
                    updatePreview();
                });
            });
            
            // –°–µ—Ç–∫–∞
            document.getElementById('gridCols').addEventListener('input', (e) => {
                state.gridCols = Math.max(1, Math.min(20, parseInt(e.target.value) || 1));
                updatePreview();
            });
            
            document.getElementById('gridRows').addEventListener('input', (e) => {
                state.gridRows = Math.max(1, Math.min(20, parseInt(e.target.value) || 1));
                updatePreview();
            });
            
            // –ù—É–º–µ—Ä–∞—Ü–∏—è
            document.getElementById('showNumbers').addEventListener('change', (e) => {
                state.showNumbers = e.target.checked;
                updatePreview();
            });
            
            // –ù–∞—Ö–ª—ë—Å—Ç
            document.getElementById('enableOverlap').addEventListener('change', (e) => {
                state.enableOverlap = e.target.checked;
                document.getElementById('overlapSlider').classList.toggle('visible', e.target.checked);
            });
            
            document.getElementById('overlapAmount').addEventListener('input', (e) => {
                state.overlapAmount = parseInt(e.target.value);
                document.getElementById('overlapValue').textContent = state.overlapAmount;
            });
            
            // –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞
            document.querySelectorAll('#exportFormat .format-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#exportFormat .format-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.exportFormat = btn.dataset.export;
                });
            });
        }
        
        // ============================================
        // –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
        // ============================================
        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    state.originalImage = img;
                    state.croppedImage = null;
                    state.imageWidth = img.naturalWidth;
                    state.imageHeight = img.naturalHeight;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                    document.getElementById('uploadCard').classList.add('hidden');
                    document.getElementById('editorSection').classList.remove('hidden');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥–∏
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step1').classList.add('completed');
                    document.getElementById('step2').classList.add('active');
                    
                    // –ê–≤—Ç–æ-–ø–æ–¥–±–æ—Ä —Å–µ—Ç–∫–∏
                    autoGrid();
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('cropperImage').src = e.target.result;
                    
                    setTimeout(updatePreview, 100);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function resetImage() {
            state.originalImage = null;
            state.croppedImage = null;
            
            document.getElementById('uploadCard').classList.remove('hidden');
            document.getElementById('editorSection').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —à–∞–≥–∏
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
        }
        
        // ============================================
        // –ê–í–¢–û-–ü–û–î–ë–û–† –°–ï–¢–ö–ò
        // ============================================
        function autoGrid() {
            const paper = getPaperSize();
            const imgRatio = state.imageWidth / state.imageHeight;
            const paperRatio = paper.width / paper.height;
            
            // –ò—â–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å–µ—Ç–∫—É (–º–∞–∫—Å 20 –ª–∏—Å—Ç–æ–≤)
            let bestCols = 2, bestRows = 2;
            let bestDiff = Infinity;
            
            for (let cols = 1; cols <= 6; cols++) {
                for (let rows = 1; rows <= 6; rows++) {
                    const gridRatio = (cols * paper.width) / (rows * paper.height);
                    const diff = Math.abs(gridRatio - imgRatio);
                    
                    if (diff < bestDiff) {
                        bestDiff = diff;
                        bestCols = cols;
                        bestRows = rows;
                    }
                }
            }
            
            state.gridCols = bestCols;
            state.gridRows = bestRows;
            document.getElementById('gridCols').value = bestCols;
            document.getElementById('gridRows').value = bestRows;
            
            updatePreview();
        }
        
        function getPaperSize() {
            const size = CONFIG.paperSizes[state.paperFormat];
            if (state.orientation === 'landscape') {
                return { width: size.height, height: size.width };
            }
            return { width: size.width, height: size.height };
        }
        
        // ============================================
        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–ï–í–¨–Æ
        // ============================================
        function updatePreview() {
            const gridOverlay = document.getElementById('gridOverlay');
            const previewImage = document.getElementById('previewImage');
            
            if (!previewImage.complete || !previewImage.naturalWidth) {
                setTimeout(updatePreview, 100);
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏
            const rect = previewImage.getBoundingClientRect();
            const displayWidth = previewImage.offsetWidth;
            const displayHeight = previewImage.offsetHeight;
            
            // –û—á–∏—â–∞–µ–º —Å–µ—Ç–∫—É
            gridOverlay.innerHTML = '';
            gridOverlay.style.width = displayWidth + 'px';
            gridOverlay.style.height = displayHeight + 'px';
            
            const cellWidth = displayWidth / state.gridCols;
            const cellHeight = displayHeight / state.gridRows;
            
            // –°–æ–∑–¥–∞—ë–º —è—á–µ–π–∫–∏ —Å–µ—Ç–∫–∏
            for (let row = 0; row < state.gridRows; row++) {
                for (let col = 0; col < state.gridCols; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.style.left = (col * cellWidth) + 'px';
                    cell.style.top = (row * cellHeight) + 'px';
                    cell.style.width = cellWidth + 'px';
                    cell.style.height = cellHeight + 'px';
                    
                    if (state.showNumbers) {
                        const label = document.createElement('span');
                        label.className = 'grid-cell-label';
                        label.textContent = `${String.fromCharCode(65 + row)}${col + 1}`;
                        cell.appendChild(label);
                    }
                    
                    gridOverlay.appendChild(cell);
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            updateSizeInfo();
        }
        
        function updateSizeInfo() {
            const paper = getPaperSize();
            const totalWidth = (paper.width * state.gridCols) / 10; // –≤ —Å–º
            const totalHeight = (paper.height * state.gridRows) / 10; // –≤ —Å–º
            const totalSheets = state.gridCols * state.gridRows;
            
            document.getElementById('posterSize').textContent = 
                `${totalWidth.toFixed(0)} √ó ${totalHeight.toFixed(0)} —Å–º`;
            document.getElementById('sheetsCount').textContent = 
                `${totalSheets} ${getSheetWord(totalSheets)}`;
            
            // –†–∞—Å—á—ë—Ç DPI (–∫–∞—á–µ—Å—Ç–≤–∞)
            const totalWidthMM = paper.width * state.gridCols;
            const totalHeightMM = paper.height * state.gridRows;
            const totalWidthInch = totalWidthMM / CONFIG.mmToInch;
            const totalHeightInch = totalHeightMM / CONFIG.mmToInch;
            
            const dpiX = state.imageWidth / totalWidthInch;
            const dpiY = state.imageHeight / totalHeightInch;
            const dpi = Math.min(dpiX, dpiY);
            
            const qualityEl = document.getElementById('printQuality');
            if (dpi >= 200) {
                qualityEl.textContent = `–û—Ç–ª–∏—á–Ω–æ (${Math.round(dpi)} DPI)`;
                qualityEl.className = 'size-info-value quality-good';
            } else if (dpi >= 100) {
                qualityEl.textContent = `–ù–æ—Ä–º–∞–ª—å–Ω–æ (${Math.round(dpi)} DPI)`;
                qualityEl.className = 'size-info-value quality-medium';
            } else {
                qualityEl.textContent = `–ù–∏–∑–∫–æ–µ (${Math.round(dpi)} DPI)`;
                qualityEl.className = 'size-info-value quality-bad';
            }
        }
        
        function getSheetWord(n) {
            const lastTwo = n % 100;
            const lastOne = n % 10;
            
            if (lastTwo >= 11 && lastTwo <= 14) return '–ª–∏—Å—Ç–æ–≤';
            if (lastOne === 1) return '–ª–∏—Å—Ç';
            if (lastOne >= 2 && lastOne <= 4) return '–ª–∏—Å—Ç–∞';
            return '–ª–∏—Å—Ç–æ–≤';
        }
        
        // ============================================
        // –ö–†–û–ü–ü–ï–†
        // ============================================
        function openCropper() {
            const modal = document.getElementById('cropperModal');
            modal.classList.add('active');
            
            const cropperImage = document.getElementById('cropperImage');
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫—Ä–æ–ø–ø–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
            if (state.cropper) {
                state.cropper.destroy();
            }
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–µ—Ç–∫–∏
            const paper = getPaperSize();
            const aspectRatio = (state.gridCols * paper.width) / (state.gridRows * paper.height);
            
            state.cropper = new Cropper(cropperImage, {
                aspectRatio: aspectRatio,
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 1,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false
            });
        }
        
        function closeCropper() {
            document.getElementById('cropperModal').classList.remove('active');
            if (state.cropper) {
                state.cropper.destroy();
                state.cropper = null;
            }
        }
        
        function applyCrop() {
            if (!state.cropper) return;
            
            const canvas = state.cropper.getCroppedCanvas({
                maxWidth: 8000,
                maxHeight: 8000,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('previewImage').src = dataUrl;
            
            const img = new Image();
            img.onload = () => {
                state.croppedImage = img;
                state.imageWidth = img.naturalWidth;
                state.imageHeight = img.naturalHeight;
                closeCropper();
                updatePreview();
            };
            img.src = dataUrl;
        }
        
        // ============================================
        // –ì–ï–ù–ï–†–ê–¶–ò–Ø –§–ê–ô–õ–û–í
        // ============================================
        async function generateOutput() {
            showProgress('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...');
            
            try {
                const fragments = await generateFragments();
                
                switch (state.exportFormat) {
                    case 'docx':
                        await generateDOCX(fragments);
                        break;
                    case 'pdf':
                        await generatePDF(fragments);
                        break;
                    case 'zip':
                        await generateZIP(fragments);
                        break;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥–∏
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step2').classList.add('completed');
                document.getElementById('step3').classList.add('active');
                
            } catch (error) {
                console.error('Error generating output:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            } finally {
                hideProgress();
            }
        }
        
        async function generateFragments() {
            const sourceImg = state.croppedImage || state.originalImage;
            const paper = getPaperSize();
            
            // –†–∞–∑–º–µ—Ä —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –ø—Ä–∏ 150 DPI
            const dpi = CONFIG.defaultDPI;
            const fragmentWidth = Math.round((paper.width / CONFIG.mmToInch) * dpi);
            const fragmentHeight = Math.round((paper.height / CONFIG.mmToInch) * dpi);
            
            // –†–∞–∑–º–µ—Ä –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const srcFragmentWidth = sourceImg.naturalWidth / state.gridCols;
            const srcFragmentHeight = sourceImg.naturalHeight / state.gridRows;
            
            // –ù–∞—Ö–ª—ë—Å—Ç –≤ –ø–∏–∫—Å–µ–ª—è—Ö
            const overlapPx = state.enableOverlap 
                ? Math.round((state.overlapAmount / CONFIG.mmToInch) * dpi)
                : 0;
            
            const fragments = [];
            
            for (let row = 0; row < state.gridRows; row++) {
                for (let col = 0; col < state.gridCols; col++) {
                    updateProgress(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç ${row * state.gridCols + col + 1} –∏–∑ ${state.gridCols * state.gridRows}...`);
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = fragmentWidth + (state.enableOverlap ? overlapPx : 0);
                    canvas.height = fragmentHeight + (state.enableOverlap ? overlapPx : 0);
                    
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // –ë–µ–ª—ã–π —Ñ–æ–Ω
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –æ–±–ª–∞—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å —É—á—ë—Ç–æ–º –Ω–∞—Ö–ª—ë—Å—Ç–∞
                    const srcOverlapX = state.enableOverlap ? (srcFragmentWidth * overlapPx / fragmentWidth) : 0;
                    const srcOverlapY = state.enableOverlap ? (srcFragmentHeight * overlapPx / fragmentHeight) : 0;
                    
                    const srcX = col * srcFragmentWidth;
                    const srcY = row * srcFragmentHeight;
                    let srcW = srcFragmentWidth;
                    let srcH = srcFragmentHeight;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Ö–ª—ë—Å—Ç —Å–ø—Ä–∞–≤–∞ –∏ —Å–Ω–∏–∑—É (–∫—Ä–æ–º–µ –∫—Ä–∞–π–Ω–∏—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤)
                    if (state.enableOverlap) {
                        if (col < state.gridCols - 1) srcW += srcOverlapX;
                        if (row < state.gridRows - 1) srcH += srcOverlapY;
                    }
                    
                    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç
                    ctx.drawImage(
                        sourceImg,
                        srcX, srcY, srcW, srcH,
                        0, 0, canvas.width, canvas.height
                    );
                    
                    // –ù—É–º–µ—Ä–∞—Ü–∏—è
                    if (state.showNumbers) {
                        const label = `${String.fromCharCode(65 + row)}${col + 1}`;
                        ctx.fillStyle = 'rgba(0,0,0,0.7)';
                        ctx.font = 'bold 48px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        // –§–æ–Ω –¥–ª—è —Ç–µ–∫—Å—Ç–∞
                        const textWidth = ctx.measureText(label).width;
                        ctx.fillStyle = 'rgba(255,255,255,0.9)';
                        ctx.fillRect(
                            canvas.width/2 - textWidth/2 - 20,
                            canvas.height/2 - 30,
                            textWidth + 40,
                            60
                        );
                        
                        ctx.fillStyle = '#333';
                        ctx.fillText(label, canvas.width/2, canvas.height/2);
                    }
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ blob
                    const blob = await new Promise(resolve => {
                        canvas.toBlob(resolve, 'image/jpeg', 0.92);
                    });
                    
                    fragments.push({
                        row,
                        col,
                        label: `${String.fromCharCode(65 + row)}${col + 1}`,
                        blob,
                        dataUrl: canvas.toDataURL('image/jpeg', 0.92),
                        width: canvas.width,
                        height: canvas.height
                    });
                    
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
                    await new Promise(r => setTimeout(r, 10));
                }
            }
            
            return fragments;
        }
        
        async function generateDOCX(fragments) {
            updateProgress('–°–æ–∑–¥–∞—ë–º DOCX —Ñ–∞–π–ª...');
            
            const { Document, Packer, Paragraph, ImageRun, PageOrientation, convertMillimetersToTwip } = docx;
            
            const paper = getPaperSize();
            
            // –°–æ–∑–¥–∞—ë–º —Å–µ–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
            const sections = [];
            
            for (const fragment of fragments) {
                const arrayBuffer = await fragment.blob.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                
                sections.push({
                    properties: {
                        page: {
                            size: {
                                width: convertMillimetersToTwip(paper.width),
                                height: convertMillimetersToTwip(paper.height),
                                orientation: state.orientation === 'landscape' 
                                    ? PageOrientation.LANDSCAPE 
                                    : PageOrientation.PORTRAIT
                            },
                            margin: {
                                top: convertMillimetersToTwip(5),
                                right: convertMillimetersToTwip(5),
                                bottom: convertMillimetersToTwip(5),
                                left: convertMillimetersToTwip(5)
                            }
                        }
                    },
                    children: [
                        new Paragraph({
                            children: [
                                new ImageRun({
                                    data: uint8Array,
                                    transformation: {
                                        width: convertMillimetersToTwip(paper.width - 10) / 15, // EMU conversion
                                        height: convertMillimetersToTwip(paper.height - 10) / 15
                                    },
                                    type: 'jpg'
                                })
                            ]
                        })
                    ]
                });
            }
            
            const doc = new Document({
                sections: sections
            });
            
            const blob = await Packer.toBlob(doc);
            saveAs(blob, `poster_${state.gridCols}x${state.gridRows}.docx`);
        }
        
        async function generatePDF(fragments) {
            updateProgress('–°–æ–∑–¥–∞—ë–º PDF —Ñ–∞–π–ª...');
            
            const { PDFDocument } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            
            const paper = getPaperSize();
            const pageWidth = paper.width * CONFIG.mmToPoint;
            const pageHeight = paper.height * CONFIG.mmToPoint;
            
            for (const fragment of fragments) {
                const page = pdfDoc.addPage([pageWidth, pageHeight]);
                
                const arrayBuffer = await fragment.blob.arrayBuffer();
                const image = await pdfDoc.embedJpg(arrayBuffer);
                
                const margin = 5 * CONFIG.mmToPoint;
                const drawWidth = pageWidth - margin * 2;
                const drawHeight = pageHeight - margin * 2;
                
                page.drawImage(image, {
                    x: margin,
                    y: margin,
                    width: drawWidth,
                    height: drawHeight
                });
            }
            
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            saveAs(blob, `poster_${state.gridCols}x${state.gridRows}.pdf`);
        }
        
        async function generateZIP(fragments) {
            updateProgress('–°–æ–∑–¥–∞—ë–º ZIP –∞—Ä—Ö–∏–≤...');
            
            const zip = new JSZip();
            const folder = zip.folder('poster_fragments');
            
            for (const fragment of fragments) {
                folder.file(`${fragment.label}.jpg`, fragment.blob);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
            const readme = `–ü–æ—Å—Ç–µ—Ä ${state.gridCols}x${state.gridRows}
===================

–§—Ä–∞–≥–º–µ–Ω—Ç—ã –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω—ã —Ç–∞–∫:
- –ë—É–∫–≤–∞ = —Å—Ç—Ä–æ–∫–∞ (A = –≤–µ—Ä—Ö–Ω—è—è)
- –¶–∏—Ñ—Ä–∞ = —Å—Ç–æ–ª–±–µ—Ü (1 = –ª–µ–≤—ã–π)

–°–µ—Ç–∫–∞ —Å–±–æ—Ä–∫–∏:
${generateGridMap()}

–§–æ—Ä–º–∞—Ç –±—É–º–∞–≥–∏: ${state.paperFormat} (${state.orientation === 'portrait' ? '–ø–æ—Ä—Ç—Ä–µ—Ç' : '–∞–ª—å–±–æ–º'})
`;
            folder.file('–ò–ù–°–¢–†–£–ö–¶–ò–Ø.txt', readme);
            
            const blob = await zip.generateAsync({ type: 'blob' });
            saveAs(blob, `poster_${state.gridCols}x${state.gridRows}.zip`);
        }
        
        function generateGridMap() {
            let map = '';
            for (let row = 0; row < state.gridRows; row++) {
                let rowStr = '';
                for (let col = 0; col < state.gridCols; col++) {
                    rowStr += `[${String.fromCharCode(65 + row)}${col + 1}] `;
                }
                map += rowStr.trim() + '\n';
            }
            return map;
        }
        
        // ============================================
        // –ü–†–û–ì–†–ï–°–°
        // ============================================
        function showProgress(text) {
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressOverlay').classList.add('active');
        }
        
        function updateProgress(text) {
            document.getElementById('progressText').textContent = text;
        }
        
        function hideProgress() {
            document.getElementById('progressOverlay').classList.remove('active');
        }
    </script>
</body>
</html>